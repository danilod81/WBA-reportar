<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Reporte de Problema de mantenimiento</title>
  <style>
    :root{ --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --border:#e5e7eb; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.5; }
    .container{ max-width:680px; margin:0 auto; padding:20px 16px 40px }
    h1{ text-align:center; font-size:clamp(1.25rem,4.8vw,1.8rem); font-weight:800; margin:6px 0 2px }
    .sub{ text-align:center; margin:2px 0 16px; color:var(--muted); font-size:.98rem; min-height:1.4em }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px }
    label{ display:block; margin:18px 0 8px; font-weight:600 }
    textarea{ width:100%; padding:14px; border:1px solid var(--border); border-radius:12px; font-size:1rem; min-height:120px; resize:vertical }
    textarea:focus{ outline:none; border-color:#9ec1ff; box-shadow:0 0 0 3px rgba(37,99,235,.15) }
    .cam{ display:grid; gap:10px }
    video{ width:100%; border-radius:12px; background:#000 }
    .row{ display:flex; gap:10px; flex-wrap:wrap }
    button{ appearance:none; border:0; border-radius:12px; padding:14px 16px; background:var(--primary); color:#fff; font-weight:600; cursor:pointer }
    .secondary{ background:#111827 }
    .thumbs{ display:flex; gap:8px; flex-wrap:wrap }
    .thumb{ position:relative }
    .thumb img{ width:90px; height:90px; object-fit:cover; border-radius:10px; border:1px solid var(--border) }
    .thumb button{ position:absolute; top:4px; right:4px; border-radius:8px; padding:4px 6px; font-size:.8rem; background:#ef4444 }
    .status{ margin-top:10px; color:var(--muted); text-align:center; font-size:.95rem; min-height:1.5em }
    .error{ color:#b91c1c }
    .ok{ color:#065f46 }
    .hidden{ display:none }
    .file-fallback{ color:var(--muted); font-size:.9rem }
    input[type=file]{ display:block; width:100% }
    .busy{ opacity:.7; pointer-events:none }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Reporte de Problema de mantenimiento</h1>
    <div id="direccionDepto" class="sub">Direcci√≥n del departamento</div>

    <div class="card">
      <!-- Enviamos con fetch para adjuntar Blobs -->
      <form id="form" novalidate>
        <input type="hidden" id="departamento" name="departamento" />
        <input type="hidden" id="reporta" name="reporta" />

        <label for="descripcion">Detalle del problema *</label>
        <textarea id="descripcion" name="descripcion" placeholder="Contanos qu√© pas√≥, d√≥nde y desde cu√°ndo‚Ä¶" required></textarea>

        <label>Fotos (sacadas ahora) *</label>

        <!-- UI de c√°mara -->
        <div id="cameraBox" class="cam">
          <video id="preview" playsinline autoplay muted></video>
          <div class="row">
            <button type="button" id="btnShot">üì∏ Tomar foto</button>
            <button type="button" id="btnFlip">üîÑ Cambiar c√°mara</button>
          </div>
          <div id="thumbs" class="thumbs"></div>
          <div class="file-fallback hidden" id="fallbackNote">No pudimos acceder a la c√°mara. Us√° este campo (intentar√° abrir la c√°mara del dispositivo):</div>
          <!-- Fallback: intenta c√°mara del SO; algunos navegadores permiten galer√≠a -->
          <input id="fallbackInput" class="hidden" type="file" name="media[]" accept="image/*" capture="environment" multiple>
        </div>

        <div class="row" style="margin-top:16px">
          <button id="submitBtn" class="secondary" type="submit">Enviar reporte</button>
        </div>
        <div id="status" class="status" role="status" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <script>
    // --------- Par√°metros de URL ---------
    const qs = new URLSearchParams(location.search);
    const depQS = (qs.get('departamento') || '').trim();
    const repQS = (qs.get('reporta') || '').trim();
    const WEBHOOK_URL = 'https://optimaltm.app.n8n.cloud/webhook/wba-reporte-mantenimiento';

    if (depQS) {
      document.getElementById('departamento').value = depQS;
      document.getElementById('direccionDepto').textContent = depQS;
    }
    if (repQS) document.getElementById('reporta').value = repQS;

    // --------- C√°mara ----------
    const video = document.getElementById('preview');
    const btnShot = document.getElementById('btnShot');
    const btnFlip = document.getElementById('btnFlip');
    const thumbs = document.getElementById('thumbs');
    const fallbackInput = document.getElementById('fallbackInput');
    const fallbackNote = document.getElementById('fallbackNote');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    const MB = 1024 * 1024;
    const MAX_FILES = 10;
    const MAX_FILE_MB = 20;

    let stream = null;
    let usingEnv = true; // c√°mara trasera por defecto
    const shots = [];    // { blob, url }

    async function startCamera() {
      try {
        if (stream) stream.getTracks().forEach(t => t.stop());
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: usingEnv ? { exact: 'environment' } : 'user' },
          audio: false
        });
        video.srcObject = stream;
        video.classList.remove('hidden');
        fallbackInput.classList.add('hidden');
        fallbackNote.classList.add('hidden');
      } catch (e) {
        // Fallback si no hay c√°mara o permisos denegados
        video.classList.add('hidden');
        fallbackNote.classList.remove('hidden');
        fallbackInput.classList.remove('hidden');
      }
    }

    function addThumb(blob) {
      const url = URL.createObjectURL(blob);
      shots.push({ blob, url });
      const div = document.createElement('div');
      div.className = 'thumb';
      div.innerHTML = `<img src="${url}" alt="foto"><button type="button">‚úï</button>`;
      div.querySelector('button').onclick = () => {
        const i = shots.findIndex(s => s.url === url);
        if (i >= 0) { URL.revokeObjectURL(shots[i].url); shots.splice(i,1); }
        div.remove();
      };
      thumbs.appendChild(div);
    }

    btnShot.addEventListener('click', async () => {
      statusEl.textContent = '';
      if (shots.length >= MAX_FILES) {
        statusEl.innerHTML = `<span class="error">M√°ximo ${MAX_FILES} fotos.</span>`;
        return;
      }
      const rect = video.getBoundingClientRect();
      const w = video.videoWidth || rect.width;
      const h = video.videoHeight || rect.height;
      const canvas = Object.assign(document.createElement('canvas'), { width: w, height: h });
      canvas.getContext('2d').drawImage(video, 0, 0, w, h);
      const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.92));
      if (!blob) { statusEl.innerHTML = '<span class="error">No se pudo capturar la foto.</span>'; return; }
      if (blob.size > MAX_FILE_MB * MB) {
        statusEl.innerHTML = `<span class="error">La foto supera ${MAX_FILE_MB} MB.</span>`;
        return;
      }
      addThumb(blob);
    });

    btnFlip.addEventListener('click', async () => {
      usingEnv = !usingEnv;
      await startCamera();
    });

    if (navigator.mediaDevices?.getUserMedia) startCamera();
    else {
      video.classList.add('hidden');
      fallbackNote.classList.remove('hidden');
      fallbackInput.classList.remove('hidden');
    }

    // --------- Env√≠o con fetch + redirecci√≥n por JSON ---------
    document.getElementById('form').addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.classList.remove('error','ok');

      const desc = (document.getElementById('descripcion').value || '').trim();
      if (!depQS)  { statusEl.innerHTML = '<span class="error">Falta ‚Äúdepartamento‚Äù.</span>'; return; }
      if (!repQS)  { statusEl.innerHTML = '<span class="error">Falta ‚Äúreporta‚Äù.</span>'; return; }
      if (!desc)   { statusEl.innerHTML = '<span class="error">Complet√° la descripci√≥n.</span>'; return; }

      const fd = new FormData();
      fd.append('departamento', depQS);
      fd.append('reporta', repQS);
      fd.append('descripcion', desc);

      if (!fallbackInput.classList.contains('hidden')) {
        const files = Array.from(fallbackInput.files || []);
        if (!files.length) { statusEl.innerHTML = '<span class="error">Adjunt√° al menos una foto.</span>'; return; }
        for (const f of files) fd.append('media[]', f, f.name);
      } else {
        if (!shots.length) { statusEl.innerHTML = '<span class="error">Sac√° al menos una foto.</span>'; return; }
        shots.forEach((s, i) => fd.append('media[]', s.blob, `foto-${i+1}.jpg`));
      }

      statusEl.textContent = 'Enviando‚Ä¶';
      submitBtn.classList.add('busy');

      try {
        const res  = await fetch(WEBHOOK_URL, { method: 'POST', body: fd });
        // intentamos parsear JSON; si no, texto
        let data = null;
        const text = await res.text();
        try { data = JSON.parse(text); } catch { data = null; }

        if (!(res.ok && data?.ok && data?.redirect)) {
          const msg = data?.message || text || `HTTP ${res.status} ${res.statusText}`;
          throw new Error(msg);
        }

        // Redirigimos nosotros (fetch no sigue 302 del backend en la UI)
        window.location.href = data.redirect;
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<span class="error">Error al enviar: ${String(err.message || err).slice(0,300)}</span>`;
      } finally {
        submitBtn.classList.remove('busy');
      }
    });
  </script>
</body>
</html>
